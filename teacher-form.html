<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù… - Ù†Ø¸Ø§Ù… ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:'Cairo',sans-serif}
body{margin:0;min-height:100vh;background:linear-gradient(135deg,#0d47a1,#1976d2)}
.wrap{max-width:900px;margin:0 auto;padding:18px 14px 40px}
.top{background:#fff;border-radius:16px;padding:16px;box-shadow:0 15px 40px rgba(0,0,0,.18);text-align:center}
.school{font-size:20px;font-weight:700;color:#0d47a1;margin:0}
.title{font-size:18px;font-weight:600;margin-top:6px;color:#333}
.card{margin-top:14px;background:#fff;border-radius:16px;padding:14px;box-shadow:0 15px 40px rgba(0,0,0,.18)}
.grid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:700px){.grid{grid-template-columns:1fr 1fr}}
label{font-size:13px;color:#333}
select,input,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:14px}
textarea{min-height:90px}
.btnRow{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:12px 16px;font-size:15px;cursor:pointer}
.btn-primary{background:#1976d2;color:#fff}
.btn-primary:hover{background:#0d47a1}
.btn-muted{background:#eee}
.msg{margin-top:10px;color:#b71c1c;min-height:18px}
.footer{text-align:center;margin-top:16px;color:#e8e8e8}
@media print{.footer{color:#333}}
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <p class="school">Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ÙÙ„Ø§Ø­ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</p>
    <p class="title" id="pageTitle">ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù… â€“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©</p>
    <a href="index.html" style="font-weight:700;color:#1976d2;text-decoration:none">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  </div>

  <div class="card">
    <div class="grid">

      <div>
        <label>ÙŠÙˆÙ… Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
        <select id="visitDay">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…</option>
          <option>Ø§Ù„Ø£Ø­Ø¯</option>
          <option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
          <option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
          <option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
          <option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
        </select>
      </div>

      <div>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
        <input type="date" id="visitDate">
      </div>

      <!-- Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø²Ø§Ø¦Ø± Ù…Ø®ÙÙŠ -->
      <input type="hidden" id="visitorTeacher">

      <div>
        <label>Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙØ²Ø§Ø±</label>
        <select id="visitedTeacher"></select>
      </div>

      <div>
        <label>Ø§Ù„Ø­ØµØ©</label>
        <select id="period"></select>
      </div>

      <div>
        <label>Ø§Ù„ÙØµÙ„</label>
        <select id="className"></select>
      </div>

      <div>
        <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <select id="subject"></select>
      </div>

      <div id="otherWrap" style="display:none">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Ø£Ø®Ø±Ù‰)</label>
        <input id="subjectOther">
      </div>

      <div style="grid-column:1/-1">
        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</label>
        <input id="lessonTitle">
      </div>

      <div style="grid-column:1/-1">
        <label>Ø§Ù„Ù‡Ø¯Ù</label>
        <textarea id="objective"></textarea>
      </div>

    </div>

  <div class="btnRow">
  <button class="btn btn-muted" onclick="location.href='index.html'">Ø±Ø¬ÙˆØ¹</button>

  <button class="btn btn-primary" id="startBtn">
    Ø¨Ø¯Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø²ÙŠØ§Ø±Ø©
  </button>

  <button class="btn btn-muted"
    onclick="window.location.href='teacher-visits.html?tid=' + new URLSearchParams(window.location.search).get('tid')">
    ğŸ“‹ Ø²ÙŠØ§Ø±Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  </button>
</div>


    <div class="msg" id="msg"></div>
  </div>

  <div class="footer">ØªØµÙ…ÙŠÙ… Ù…Ø­Ù…Ø¯ Ø¹Ø§Ù…Ø± Ø£Ø­Ù…Ø¯</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, addDoc, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyBbUryd9blqEG60L15-L_wU8-NORoHq4r4",
  authDomain: "visit-2026.firebaseapp.com",
  projectId: "visit-2026"
});
const db = getFirestore(app);

/* get tid */
const params = new URLSearchParams(window.location.search);
const teacherId = params.get("tid");
if(!teacherId){
  location.href = "index.html";
}

/* elements */
const visitedTeacher = document.getElementById("visitedTeacher");
const className = document.getElementById("className");
const subject = document.getElementById("subject");
const period = document.getElementById("period");
const visitDay = document.getElementById("visitDay");
const visitDate = document.getElementById("visitDate");
const subjectOther = document.getElementById("subjectOther");
const otherWrap = document.getElementById("otherWrap");
const lessonTitle = document.getElementById("lessonTitle");
const objective = document.getElementById("objective");
const msg = document.getElementById("msg");
const pageTitle = document.getElementById("pageTitle");

/* helpers */
function addDefault(sel,text){
  sel.innerHTML="";
  const o=document.createElement("option");
  o.value="";o.textContent=text;
  sel.appendChild(o);
}

function fillPeriods(){
  addDefault(period,"Ø§Ø®ØªØ± Ø§Ù„Ø­ØµØ©");
  ["Ø§Ù„Ø£ÙˆÙ„Ù‰","Ø§Ù„Ø«Ø§Ù†ÙŠØ©","Ø§Ù„Ø«Ø§Ù„Ø«Ø©","Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©","Ø§Ù„Ø®Ø§Ù…Ø³Ø©","Ø§Ù„Ø³Ø§Ø¯Ø³Ø©","Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©","Ø§Ù„Ø«Ø§Ù…Ù†Ø©"]
    .forEach((t,i)=>{
      const o=document.createElement("option");
      o.value=i+1;
      o.textContent="Ø§Ù„Ø­ØµØ© "+t;
      period.appendChild(o);
    });
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù…Ø¹ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø²Ø§Ø¦Ø± */
async function loadVisitedTeachersExcludeVisitor(){
  addDefault(visitedTeacher,"Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙØ²Ø§Ø±");

  const res = await getDocs(
    query(collection(db,"teachers"), where("active","==",true))
  );

  res.forEach(d=>{
    if(d.id === teacherId) return; // â›” Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù†ÙØ³Ù‡
    const o=document.createElement("option");
    o.value=d.id;
    o.textContent=d.data().name || "";
    visitedTeacher.appendChild(o);
  });
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø²Ø§Ø¦Ø± */
async function loadVisitorTeacher(){
  const snap = await getDoc(doc(db,"teachers",teacherId));
  if(!snap.exists()){
    location.href="index.html";
    return;
  }
  pageTitle.textContent = "ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù… â€“ " + (snap.data().name || "");
}

/* subject other */
subject.onchange = ()=>{
  otherWrap.style.display = subject.value==="__other__" ? "block" : "none";
};

/* start visit */
document.getElementById("startBtn").onclick = async ()=>{
  msg.textContent="";

  if(
    !visitDay.value ||
    !visitDate.value ||
    !visitedTeacher.value ||
    !period.value ||
    !className.value ||
    !subject.value ||
    !lessonTitle.value.trim() ||
    !objective.value.trim()
  ){
    msg.textContent="ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";
    return;
  }

  try{
    const ref = await addDoc(collection(db,"visits"),{
      visitDay: visitDay.value,
      visitDate: visitDate.value,

      visitorTeacherId: teacherId,
      visitorTeacherName: pageTitle.textContent.replace("ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù… â€“ ",""),

      visitedTeacherId: visitedTeacher.value,
      visitedTeacherName: visitedTeacher.options[visitedTeacher.selectedIndex].textContent,

      period: Number(period.value),
      periodText: period.options[period.selectedIndex].textContent,

      classId: className.value,
      classText: className.options[className.selectedIndex].textContent,

      subjectText:
        subject.value==="__other__"
          ? subjectOther.value.trim()
          : subject.options[subject.selectedIndex].textContent,

      lessonTitle: lessonTitle.value.trim(),
      objective: objective.value.trim(),

      status: "draft",
      createdAt: Date.now()
    });

    window.location.href = "visit-form.html?id=" + ref.id;

  }catch(e){
    msg.textContent="Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø©";
  }
};

/* init */
fillPeriods();
loadVisitorTeacher();
loadVisitedTeachersExcludeVisitor();

addDefault(className,"Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„");
addDefault(subject,"Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©");

const cls = await getDocs(query(collection(db,"classes"), where("active","==",true)));
cls.forEach(d=>{
  const o=document.createElement("option");
  o.value=d.id;o.textContent=d.data().name;
  className.appendChild(o);
});

const subs = await getDocs(query(collection(db,"subjects"), where("active","==",true)));
subs.forEach(d=>{
  const o=document.createElement("option");
  o.value=d.id;o.textContent=d.data().name;
  subject.appendChild(o);
});

const otherOpt=document.createElement("option");
otherOpt.value="__other__";
otherOpt.textContent="Ø£Ø®Ø±Ù‰";
subject.appendChild(otherOpt);
</script>

</body>
</html>
